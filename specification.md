# AIエージェントによる自動株ポートフォリオ運用（シミュレーション）

## 1. 最終目標

AIエージェントが自動で株式ポートフォリオを運用する Web アプリを構築する（仮想口座・仮想取引でのシミュレーション）。

## 2. フェーズ目標

* 目標1：ローカルで動くものを作る

  * 1-1. バックエンド実装＋CLIで動作確認
    * SQLite を利用したポートフォリオ状態管理
    * Planner / Explorer / ResearchLeader / Decider / Checker の各エージェントを Python クラスとして実装
    * バックエンド実装は `backend/kabupilot/` 配下に配置し、`python -m kabupilot.cli` 経由で初期化・週次計画・日次実行・状態確認コマンドを提供
    * CLI は設定コマンドで日本株（デフォルト）または米国株のどちらを扱うか切り替え可能（設定値は SQLite に保存）
  * 1-2. フロントエンド実装
* 目標2：実環境（デプロイ）で動くものを作る

## 3. スコープ

* 対象：当面はシミュレーション専用（仮想口座・仮想取引）
* 目的：AIエージェント（GPT-5、Grok）を直列・並列稼働させ、目標設定 → ポートフォリオ更新（購入/売却） → 評価・学習のサイクルを自動化
* 成果物：

  1. CLI で動作するバックエンド
  2. Web UI

## 4. 技術スタック（例）

* バックエンド：Python 3.11、FastAPI、APScheduler、SQLite（→ 後で PostgreSQL）、将来は Redis＋Dramatiq/Celery
* フロントエンド：Next.js（App Router）、Tailwind CSS、Recharts
* 株価取得API：まずは yfinance、将来は他APIへ置換可能な Provider アダプタ層
* AIエージェント：openai と xai-sdk（Grok）、LLMプロバイダ抽象インターフェースを定義

## 5. 全体フロー（運用）

* 週次：週初に週の目標を設定 → 各営業日で「ポートフォリオ更新 →（市場引け時）→ 反省」 → 週末に1週間のまとめ
* 共通：各エージェントは入出力を JSON で統一し、活動記録（ログ）を残す

## 6. エージェント定義

### 6.1 Planner（週初の計画）

* 入出力

  * 入力：―
  * 出力：サマリ、活動記録
* 使用ツール：ナレッジベース取得、資金情報取得、保有銘柄・ウォッチリスト取得、週の目標設定
* 主要機能

  * 資金情報・現在保有に基づき週次目標を策定
  * 活動記録を作成

### 6.2 PortfolioUpdater（営業日ループの実行）

* 入出力

  * 入力：1日の目標
  * 出力：サマリ、活動記録
* 使用ツール：ナレッジベース取得、Explorer、ResearchLeader、Decider 実行、保有・ウォッチ変更、資金・保有取得、活動記録書き込み
* 主要機能

  1. Explorerで候補銘柄抽出
  2. ResearchLeaderが候補を調査・採点
  3. Deciderに保有・ウォッチ変更案を照会
  4. 実際の保有・ウォッチを更新
  5. 関連活動を一括で記録

### 6.3 Explorer（候補抽出）

* 入出力

  * 入力：現在の保有・ウォッチ
  * 出力：銘柄コードのリスト、活動記録
* 使用ツール：ナレッジベース取得、インターネット検索
* 主要機能

  * まずナレッジベース参照
  * 現有＋新規候補を探索
  * 活動記録を残す

### 6.4 ResearchLeader（並列調査の統括）

* 入出力

  * 入力：銘柄コードのリスト
  * 出力：銘柄コード＋点数＋理由のリスト、活動記録
* 使用ツール：ナレッジベース取得、Researcher の並列実行
* 主要機能

  * ナレッジベース参照
  * 各銘柄について同一プロンプトで Researcher を並列起動
  * 結果を集約して採点＋理由リストを作成
  * 活動記録を残す

### 6.5 Researcher（個別調査）

* 入出力

  * 入力：銘柄コード
  * 出力：0–1 の点数、理由
* 使用ツール：インターネット検索、Grok（X の動向調査）
* 主要機能

  * 該当銘柄の広範・深掘り調査
  * スコアを 0–1 に正規化
  * 理由を付与

### 6.6 Decider（意思決定）

* 入出力

  * 入力：資金情報、銘柄＋点数リスト、現在の保有・ウォッチ
  * 出力：保有変更点、ウォッチ変更点、サマリ、活動記録
* 使用ツール：ナレッジベース取得
* 主要機能

  * ナレッジベース参照
  * 候補銘柄をランキング
  * 保有銘柄・数量の追加/削減/削除、ウォッチ更新を決定
  * 変更サマリと活動記録を作成

### 6.7 Checker（終日評価／週次レビュー）

* 入出力

  * 入力：活動記録、週の目標
  * 出力：サマリ
* 使用ツール：ナレッジベース更新、資金情報取得、保有・ウォッチ取得
* 主要機能

  * 活動記録・資金・保有から結果を評価し、改善点を抽出してナレッジベースを更新
  * 本日のサマリ（週末は週間サマリ）を出力

## 7. データ管理の要点

* インターフェース：各エージェントの入出力は JSON で統一
* ログ：全工程で活動記録（誰が・何を・なぜ）を残し、Checker が学習（KB 更新）に活用
* 意思決定の流れ：Explorer（候補抽出） → Researcher/Leader（評価） → Decider（配分・更新） → PortfolioUpdater（実行） → Checker（評価・学習）

## 8. 時系列（テキスト図）

```
[週初] Planner: 週目標設定
   ↓ (毎営業日)
PortfolioUpdater: 1日目標に基づく更新
   ├─ Explorer → 候補銘柄
   ├─ ResearchLeader → 銘柄スコア
   ├─ Decider → 保有/ウォッチ更新
   └─ 記録作成
(市場引け) Checker: 振り返り・KB更新 → 日次サマリ
   ↓ (繰り返し)
[週末] Checker/Planner: 週間サマリ & 次週の改善点
```
